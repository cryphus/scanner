<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>QR Scanner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Библиотеки -->
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
        body{
            display:flex;flex-direction:column;justify-content:center;align-items:center;
            min-height:100vh;padding:20px;
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
            background:#1a1a1a;color:#fff;
        }
        .container{width:100%;max-width:500px;text-align:center}
        #reader{
            position:relative;width:100%;border-radius:20px;overflow:hidden;background:#2a2a2a;
            box-shadow:0 8px 32px rgba(0,0,0,.3);
        }
        #reader video{width:100%;height:auto;border-radius:20px}
        .camera-switch{
            position:absolute;bottom:20px;right:20px;z-index:10;
            display:flex;align-items:center;gap:8px;
            background:rgba(0,0,0,.5);border:none;border-radius:20px;
            color:#fff;padding:10px 20px;font-size:16px;cursor:pointer;
            transition:background .3s;
        }
        .camera-switch:hover{background:rgba(0,0,0,.7)}
        .camera-switch svg{width:20px;height:20px}
        .status{
            margin-top:20px;padding:15px;border-radius:10px;background:#2a2a2a;font-size:16px;
            opacity:0;transition:opacity .3s ease;
        }
        .status.visible{opacity:1}
        .status.success{background:#28a745}
        .status.error{background:#dc3545}
    </style>
</head>
<body>
    <div class="container">
        <div id="reader">
            <button class="camera-switch" onclick="switchCamera()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/>
                    <circle cx="12" cy="13" r="4"/>
                </svg>
                Сменить камеру
            </button>
        </div>
        <div id="status" class="status"></div>
    </div>

<script>
    Telegram.WebApp.ready(); // сообщаем Telegram, что WebApp загружен

    let html5QrcodeScanner;
    let availableCameras = [];
    let currentCameraIndex = 0;
    const statusDiv = document.getElementById('status');

    function showStatus(message, success){
        statusDiv.textContent = message;
        statusDiv.className = `status ${success? 'success':'error'} visible`;
        setTimeout(()=>statusDiv.className='status',3000);
    }

    function onScanSuccess(decodedText){
        if(html5QrcodeScanner){html5QrcodeScanner.pause();}
        showStatus('QR‑код успешно отсканирован!',true);
        Telegram.WebApp.sendData(decodedText);
        setTimeout(()=>Telegram.WebApp.close(),2000);
    }

    function onScanFailure(err){console.warn('Ошибка сканирования:',err);}

    function startScanner(cameraConfig){
        const config={
            fps:10,
            qrbox:{width:250,height:250},
            aspectRatio:1,
            showTorchButtonIfSupported:true,
            showZoomSliderIfSupported:true,
            defaultZoomValueIfSupported:2,
            formatsToSupport:[Html5QrcodeSupportedFormats.QR_CODE]
        };

        html5QrcodeScanner=new Html5Qrcode('reader');
        html5QrcodeScanner.start(cameraConfig,config,onScanSuccess,onScanFailure)
            .catch(err=>{console.error(err);showStatus('Не удалось запустить камеру',false);});
    }

    async function switchCamera(){
        if(availableCameras.length<2){showStatus('Доступна только одна камера',false);return;}
        if(html5QrcodeScanner){await html5QrcodeScanner.stop();}
        currentCameraIndex=(currentCameraIndex+1)%availableCameras.length;
        const cam=availableCameras[currentCameraIndex];
        showStatus(`Камера: ${cam.label||cam.id}`,true);
        startScanner(cam.id);
    }

    function initScanner(){
        // Сначала пытаемся получить список устройств
        Html5Qrcode.getCameras().then(devices=>{
            if(!devices.length){showStatus('Камеры не найдены',false);return;}
            availableCameras=devices;
            // Ищем камеру с пометкой rear/back/environment
            const rearIdx=devices.findIndex(d=>/rear|back|environment/i.test(d.label));
            currentCameraIndex=rearIdx>=0? rearIdx:0;
            const initialCam=devices[currentCameraIndex];
            startScanner(initialCam.id);
        }).catch(err=>{
            console.warn('Не удалось получить список камер, пробуем facingMode',err);
            // Если список недоступен (iOS до разрешения) — пробуем constraints
            startScanner({ facingMode:{ exact:'environment' } });
        });
    }

    window.addEventListener('load',initScanner);
</script>
</body>
</html>
